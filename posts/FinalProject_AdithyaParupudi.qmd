---
title: "Final Project - EDA of NIFTY50 Dataset"
author: "Adithya Parupudi"
desription: "Analysing NIFTY50 Stocks between 2000-2021"
date: "09/03/2022"
format:
  html:
    toc: true
    code-fold: true
    code-copy: true
    code-tools: true
categories:
  - tidyverse
  - final_project
  - Adithya Parupudi
---

## Load Libraries

```{r}
#| label: setup
#| warning: false

library(tidyverse)
library(ggplot2)
library(ggforce)
library(forcats)
library(lubridate)
library(hrbrthemes)
library(plotly)

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE}

```

## Introduction

The NIFTY 50 is a benchmark Indian stock market index that represents the weighted average of 50 of the largest Indian companies listed on the National Stock Exchange. It is one of the two main stock indices used in India, the other being the BSE SENSEX. With the dataset I got from kaggle, I will perform an EDA of the stock prices listed from 2000 to 2021. Some answers I wanted to find out were :

-   Do all stocks remain the same each year?

-   What is the best and worst stock in a year?

-   What is the stock performance of companies that I regularly use?

### Column Descriptions

Description of columns in the file:

-   Date --- Date of trade

-   symbol --- Name of the company

-   Series --- We have only one series - EQ, which stands for Equity.

-   Prev Close --- Refers to the final price of a stock of the previous dat when the market officially closes, which is at 3:30pm IST

-   Open --- The open is the starting period of trading on a securities exchange or organized over-the-counter market.

-   High --- Highest price at which a stock traded during the course of the trading day.

-   Low --- Lowest price at which a stock traded during the course of the trading day.

-   Last --- The last price of a stock is just one price to consider when buying or selling shares. The last price is simply the most recent one

-   Close --- The close is a reference to the end of a trading session in the financial markets when the markets close for the day.

-   VWAP (Volume-weighted average price)- It is the ratio of the value traded to total volume traded over a particular time horizon. It is a measure of the average price at which a stock is traded over the trading horizon

-   Volume --- It is the amount of a security that was traded during a given period of time

-   Turnover -It is a measure of sellers versus buyers of a particular stock. It is calculated by dividing the daily volume of a stock by the "float" of a stock, which is the number of shares available for sale by the general trading public.

-   Trades- The number of shares being traded on a given day is called trading volumes

-   Deliverable Volume --- quantity of shares which actually move from sellers to buyers

-   %Deliverable --- shares which are actually transferred from one person's to another's demat account.

## Read Data

There are multiple .csv files, one for each stock, which are placed in a folder. I am reading data from all the csv files and combining them into a single data-frame using purrr package.

```{r}
all_stocks <- dir("_data/NIFTY_AdithyaParupudi/", full.names = TRUE) %>%  map_dfr(read_csv, )
all_stocks <- tibble(all_stocks)

```

```{r}
str(all_stocks)
```

## Data Cleaning

### Renaming column

The last column has a spelling mistake. Changing that to PercentDeliverable to avoid confusion and also renamed another column to camel-casing

```{r}
all_stocksv2 <- all_stocks %>% rename(PercentDeliverable = `%Deliverble`, DeliverableVolume = `Deliverable Volume`)
colnames(all_stocksv2)

```

The date format is yyyy/mm/dd. I only want the year aspect, so creating a new column with just that. A new column 'yy' has been created, which is the last column

```{r}

x<-format(as.Date(all_stocksv2$Date, format="%Y/%m/%d"))

all_stocks_yy <- all_stocksv2 %>% 
  mutate(yy=year(x)) %>%
  select(-Date)
print(all_stocks_yy)

```

### Checking missing data

By running the summary command we see that Trades, Deliverable Volume and Percent_Deliverables have a lot of missing values. Since they are all numeric, I'm replacing them with 0 to avoid calculation errors.

```{r}

print(summarytools::dfSummary(all_stocks_yy,
                        varnumbers = FALSE,
                        plain.ascii  = FALSE, 
                        style        = "grid", 
                        graph.magnif = 0.70, 
                        valid.col    = FALSE),
      method = 'render',
      table.classes = 'table-condensed')
```

### Replacing NA's with 0's

NA in the dataset are because - no trades happened to that stock when it was first listed in the NIFTY50 index. It is equal to 0, as no activity happened. NA's are present only in the numeric columns. So, I am replacing all the NA with 0

I tried using replace_na() but it wouldn't replace the NA's. So I had to use the base-r function for this.

```{r}

all_stocks_yy[is.na(all_stocks_yy)] <- 0
sum(is.na(all_stocks_yy$Trades))
```

## Observations

### Distinct stocks

NIFTY50 is supposed to be the top 50 stocks of the financial year(there must be 50 distinct stocks in the data set). This data from 2000 to 2021 is not consistent, i.e., there are **65** distinct entries found. Which suggests that some stocks under-performed and got replaced with new ones over time.

```{r}
all_stocks_yy %>% select(1) %>% distinct()
```

### Year vs Volume of stock traded

We can infer from the mean of Volume column, the number of stocks sold each year kept increasing.

1.  This can hint an increase in demat accounts and number of active trading as well.

2.  New stocks must have entered the NIFTY50 index, and started performing well over the years

3.  Special attention can be paid to volumes of stock sold between 2018 - 2021. There is a sharp increase in the volume of shares traded. Due to the COVID-19 pandemic, many stocks fell which encouraged more people than ever to open a demat account and start investing( I opened mine during this time!!!)

```{r}

barplot<- all_stocks_yy %>% 
  group_by(yy) %>% 
  select(`Volume`) %>% 
  summarise_all(mean, na.rm=TRUE)

barplot(height=barplot$Volume, names=barplot$yy, 
        col="#69b3a2",
        horiz=T, las=1,
        xlab='Volume --->',
        ylab='Year --->',
        main='Year v/s Volume',
        )

```

### Checking stock's consistency in NIFTY50 index

By running the below code, I am checking whether a stock has maintained its consistency in the top 50 stocks. Looks like the top 50 stocks kept changing each year, and some stocks were not present in the list. The stocks not present in that year can be identified with 0 ( a metric for the sum of all shares sold in a year)

Some observations that can be made here :

1.  Stocks like ADANIPORTS, NESTLEIND, NTPC, SSLT didn't enter the stock market from 2000's. Their companies began listing further down the line, such as from 2010
2.  Some companies, though made it to the NIFTY 50 list, have dropped out over the years due to a dip in stock price due to various factors. Some such examples would be KOTAKMAH, INFOSYSTCH, TELCO, TISCO and so on

```{r}

all_stocks_yy %>% 
  pivot_wider(names_from=`yy`, values_from = `Volume`) %>% 
  group_by(Symbol) %>% select(Trades, 14:35) %>% 
  summarise_all(sum, na.rm=TRUE) %>% 
  relocate(`2000`:`2006`, .before = `2007`)

```

### Stocks which didn't enter stock market for 10 yrs

There are 6 stocks which did not enter the stock market - ADANIPORTS, HEROMOTOCO, INFY,SSLT,UPL, VEDL. They were not publicly listed in to be traded, as they were still in the developmental phases. A company enters stock market once it has captured enough market in an area, and wants to expand its operations and brand to a larger scale.

```{r}
all_stocks_yy %>% 
  pivot_wider(names_from=`yy`, values_from = `Volume`) %>% 
  group_by(Symbol) %>% select(Trades, 14:35) %>% 
  summarise_all(sum, na.rm=TRUE) %>% 
  relocate(`2000`:`2006`, .before = `2007`) %>% 
  select(`Symbol`, `2000`:`2010`) %>% 
  filter(across(`2000`:`2010`, ~ . ==0)) %>% 
  select(Symbol)
```

### Best and Worst Performing Stock of 2000

ZEETELE - Best performing stock in 2000, AJAUTOFIN - Worst performing stock 2000. They are calculated based on their cumulative volumes of all the years respectively

```{r}
# best performing stock
all_stocks_yy %>% 
  group_by(yy, Symbol) %>% 
  select(`Volume`) %>% 
  summarise_all(sum, na.rm=TRUE) %>% 
  arrange(desc(Volume)) %>% 
  slice(1)

# worst performing stock
all_stocks_yy %>% 
  group_by(yy, Symbol) %>% 
  select(`Volume`) %>% 
  summarise_all(sum, na.rm=TRUE) %>% 
  arrange(Volume) %>% 
  slice(1)

```

#### Plotting the above results

I have plotted a connected scatterplot for the best and the worst stock as shown below. It was surprising to see such a sharp decline in traded volumes for ZEETELE just the corresponding year. And the worst performing stock of 2000 gradually gained traction and crossed the aforementioned stock in the year 2006.

The dip in stock volume is observed for BAJAUTOFIN due to the stock market crash, but still continues to maintain its position in the NIFTY index. Looks like ZEETELE got kicked of the NIFTY index at the beginning of 2007

Red line - BAJAUTOFIN , Blue Line - ZEETELE

```{r}


p<-all_stocks_yy %>% 
  select(Symbol, yy, `Prev Close`) %>% 
  filter(Symbol == "ZEETELE" | Symbol == "BAJAUTOFIN") %>% 
  group_by(yy, Symbol) %>% 
  summarize_all(mean, na.rm = TRUE) %>% 
  pivot_wider(names_from = Symbol, values_from = `Prev Close`) %>% 
  ggplot()+
  geom_line(aes(x=yy, y=BAJAUTOFIN), color='red') + 
  geom_point(aes(x=yy, y=BAJAUTOFIN),size=1.5, color='red') + 
  geom_line(aes(x=yy, y=ZEETELE), color='blue') + 
  geom_point(aes(x=yy, y=ZEETELE),size=1.5, color="blue") +   
  labs(title='ZEETELE, BAJAUTOFIN - Stock performance', x="Year", y="Previous Close") + theme_bw() 

ggplotly(p)
```

### Best and Worst stock of 2021 by Volume

Best performing stock was TATAMOTORS, and the worst performing stock was SHREECEM

```{r}
# best performing stock of 2021
all_stocks_yy %>% 
  group_by(yy, Symbol) %>% 
  select(`Volume`) %>% 
  summarise_all(sum, na.rm=TRUE) %>% 
  arrange(desc(Volume)) %>% 
  filter(yy==2021) %>% 
  head()

# worst performing stock of 2021
all_stocks_yy %>% 
  group_by(yy, Symbol) %>% 
  select(`Volume`) %>% 
  summarise_all(sum, na.rm=TRUE) %>% 
  arrange(Volume) %>% 
  filter(yy==2021) %>% 
  head()

```

#### Plotting the above results

Over the years, SHREECEM have observed a steady growth. Its a cement manufacturing company from Rajasthan, who played a valuable role in India's development.

```{r}

stocks_2021<-all_stocks_yy %>% 
  select(Symbol, yy, `Prev Close`) %>% 
  filter(Symbol == "TATAMOTORS" | Symbol == "SHREECEM") %>% 
  group_by(yy, Symbol) %>% 
  summarize_all(mean, na.rm = TRUE) %>% 
  pivot_wider(names_from = Symbol, values_from = `Prev Close`) %>% 
  ggplot()+
  geom_line(aes(x=yy, y=SHREECEM), color='red') + 
  geom_point(aes(x=yy, y=SHREECEM),size=1.5, color='red') + 
  geom_line(aes(x=yy, y=TATAMOTORS), color='blue') + 
  geom_point(aes(x=yy, y=TATAMOTORS),size=1.5, color="blue") +   
  labs(title='TATAMOTORS, SHREECEM - Stock performance', x="Year", y="Previous Close") + theme_bw() 

ggplotly(stocks_2021)
```

### Which stock plummeted the most in 2008?

The answer to that question is SESAGOA - an Iron Ore company in Goa

```{r}

stocks_2008 <- all_stocks_yy %>% filter(`yy` == 2008) %>% 
  select(yy, Symbol, `Prev Close`) %>% 
  group_by(Symbol,yy) %>% 
  summarise_all(median, na.rm=TRUE) %>% 
  ungroup() %>% 
  arrange(desc(`Prev Close`)) %>% 
  head()

bar_2008<- stocks_2008 %>% ggplot(aes(x=`Prev Close`, y=Symbol, color=yy)) + 
  geom_bar(stat="identity", fill="#f68060", alpha=.6, width=.4) +
    theme_bw()

ggplotly(bar_2008)


```

### Stock performance between 2018 to 2021

I've picked a few stocks whose brands I am most familiar with and use their services in daily life. It was interesting to see that Britannia and HDFC stocks fell by a large number and quickly recovered in 2021. Their brand image is really good in the Indian market and they are immune to market volatility. These are some of the best long term investment options.

```{r}
stock_perf <- all_stocks_yy %>% 
  filter(`yy` == 2018 | `yy` == 2019 | `yy` == 2020 |`yy` == 2021) %>% 
   filter(Symbol == 'ADANIPORTS' |
Symbol == 'ASIANPAINT' | Symbol == 'BRITANNIA' | Symbol == 'INFY' | Symbol == 'CIPLA' | Symbol == 'HDFCBANK' | Symbol == 'RELIANCE' | Symbol == 'TCS' |Symbol == 'TECHM') %>% 
   select(yy,Symbol, `Prev Close`) %>% 
   group_by(Symbol,yy) %>% 
   arrange(`Prev Close`) %>% 
   slice(1) 

 
stock_perf%>% ggplot( aes(x=yy,y=`Prev Close`, label = yy)) +
    geom_line( color="grey") +
    geom_point(color="blue", size=2) +
  facet_wrap(~Symbol,nrow =4) +
  labs(x='year', y='Prev Close')
    ggtitle("Stock performance during COVID-19") + theme_dark()

```

### Highest and Lowest stock prices observed in dataset

Calculating this based on Prev Close column, which tells the last traded price of the stock.

Highest price is observed for EICHERMOT aka Eicher Motors Ltd in 2017, traded at 32,861.95 rupees per share. It is an Indian MNC which manufactures motorcycles and commercial vehicles, headquartered in New Delhi.

Lowest prices don't really count as per the code because the stock price is close to 0 when it enters the stock market.

```{r}

all_stocks_yy %>% 
  select(Symbol, `Prev Close`, yy) %>% 
  arrange(desc(`Prev Close`)) %>% 
  head()

all_stocks_yy %>% 
  select(Symbol, `Prev Close`, yy) %>% 
  arrange(`Prev Close`) %>% 
  head()

```

### Which stock consistently maintained its position for the longest time?

Below are the list of 23 stocks which are consistently a part of NIFTY. Just like all the other stocks, they also experienced heavy price drops, but also gained the market share just as fast. These are the best performing stocks of the Indian market and we can safely invest in them for the long run.

```{r}

all_stocks_yy %>% 
  pivot_wider(names_from=`yy`, values_from = `Volume`) %>% 
  group_by(Symbol) %>% select(Trades, 14:35) %>% 
  summarise_all(sum, na.rm=TRUE) %>% 
  relocate(`2000`:`2006`, .before = `2007`) %>% 
  select(`Symbol`, `2000`:`2021`) %>% 
  filter(across(`2000`:`2021`, ~ . !=0)) %>% 
  select(Symbol)
```

## Reflection

This project has been a great learning experience for me. It was interesting to see how many insights can be derived from a single data set. I felt I barely scratched the surface of this goldmine. I used to follow stock market trends for a while, which got me interested to try this do an EDA of this data-set. My current regret is, there are lot of amazing insights and visualizations that I could do, but I didn't know how to manipulate multiple variables to make it happen.

I faced challenges with almost every aspect of this project. I've been going back to my notes, stack overflow and a bunch of youtube videos to get clarity. I made use of really good websites and bookmarked some of the solutions for future reference. There is a lot of power in R and it made me realize I could really do a lot more with it.

I've made use of other packages apart from the standard ones taught in the class, and tried resolving multiple errors by fine-tuning the functions. There is still a lot more to learn, and I will continue learning to be better at visualization.

## Conclusion

I got some clarity on the highs and lows of the stock market. A stock doesn't appear to be consistent in the NIFTY index and new ones get added or replaced each consecutive year. Sometimes the stocks start at a very high price, but plummets almost immediately the next year,which makes it very dangerous to have had shares in that stock(,i.e., ZEETELE). Some stocks stood the test of time and their brand image grew bigger. Not all stocks started out at year 2000, while some of them entered almost 10 years later and continued to be in the NIFTY index.

A stocks performance directly proportional to its public image. The stock price immediately drops if the company's image is tarnished. The number of people who started investing in the stock grew each year, and the highest jump in the traded volumes can be observed between 2018 to 2021, a direct consequence of COVID-19 pandemic. Since people were restricted at home, there was a lot of surplus amount sitting idle in bank accounts. Therefore they invested in the stock markets which were crashing due to the declining businesses. All the NIFTY stocks will rise each time they fall, is what I've observed, but stocks from the manufacturing industry will only experience temporary dips in price.

As India is a developing country, there is a continuous involvement of the manufacturing industry. So even if there is a plateau in price, the price and public sentiment will eventually rise.

## Bibliography

Dataset from kaggle - https://www.kaggle.com/datasets/rohanrao/nifty50-stock-market-data

Definitions - https://en.wikipedia.org/wiki/NIFTY_50
